  
  # This package is used for PCA
  library(factoextra)
  
  
  # Creates the dataframe for kable and for later PCA.
  
  temp_fieldall2=fieldData %>% 
  group_by(Stream.Code,Year,Site.number,Reach) %>%
  summarize(temp=round(mean(Water.Temperature.C),3),ph=round(mean(pH),3),flow=round(mean(Transect.Flow.cms),3),
  depth=round(mean(eDNA.Total.Water.Depth.m),3),shore=round(mean(eDNA.Distance.from.Shore.m),3))        
  
# Turn into dataframe and name columns.
temp_fieldall2=data.frame(temp_fieldall2)
names(temp_fieldall2)=c("Stream","Year","Site","Reach","Temperature","pH","Flow (cm/s)","Depth","Shore")

# Remove non numeric column
temp_fieldall3=temp_fieldall2 %>% dplyr::select(-Reach) # Remove reach because it is non-numeric


# Take off stream and replace by stream as row name
temp_fieldall3=temp_fieldall3[,-1] 

# factoextra requires non repeating names.
streams=c('AA1','AA2','AA3','BB1','BB2','BB3','CC1','CC2','CC3','CC4','CC5','CC6','DD1','DD2','DD3','DD4','DD5','DD6')
row.names(temp_fieldall3)=streams


# Get compontents, scale to unit variance.
res.pca<-prcomp(temp_fieldall3,scale=TRUE)

# Scree Plot
fviz_eig(res.pca)

# Use cos2 as we want comparitive, green is least impact, red is most impact
fviz_pca_ind(res.pca,
             col.ind = "cos2", # Color by the impact
             gradient.cols = c("green", "yellow", "red"),
             repel = TRUE     # We don't want the text to overlap
             )
             
             
             
 # Bi plot
fviz_pca_biplot(res.pca, repel = TRUE,
                col.var = "#2E9FDF", # Variables color
                col.ind = "#696969"  # Individuals color
                )



# Add a column of numeric stream code.
# AAA is 0 
# BBB is 1
# CCC is 2
# DDD is 3


streamcode=c(rep(0,3),rep(1,3),rep(2,6),rep(3,6))
temp_fieldall3$code=streamcode
groups <- as.factor(temp_fieldall3$code)

# Ellipses
fviz_pca_ind(res.pca,
             col.ind = groups, # color by groups
             palette = c("red","blue","green","yellow"),
             addEllipses = TRUE, # Concentration ellipses
             ellipse.type = "confidence",
             legend.title = "Groups",
             repel = TRUE
             )


######### Alternate #############

# Remove both Year and Site and repeat as above.
temp_fieldall4=temp_fieldall3[,c(-1,-2)]

res.pca2<-prcomp(temp_fieldall4,scale=TRUE)


fviz_pca_ind(res.pca2,
             col.ind = "cos2", # Color by the quality of representation
             gradient.cols = c("green", "yellow", "red"),
             repel = TRUE     # Avoid text overlapping
             )



fviz_pca_var(res.pca2,
             col.var = "contrib", # Color by contributions to the PC
             gradient.cols = c("green", "yellow", "red"),

             repel = TRUE     # Avoid text overlapping
             )



fviz_pca_biplot(res.pca2, repel = TRUE,
                col.var = "#2E9FDF", # Variables color
                col.ind = "#696969"  # Individuals color
                )
